<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover, interactive-widget=resizes-content">
  <meta name="theme-color" content="#010409">
  <title>Onyx Color</title>
  <style>
    /* --- SYSTEM TOKENS --- */
    :root {
      --bg: #010409;
      --surface: #0d1117;
      --border: #30363d;
      --accent: #2f81f7;
      --text: #e6edf3;
      --text-muted: #7d8590;
      --font-code: "SF Mono", "Menlo", monospace;
      --font-ui: -apple-system, BlinkMacSystemFont, sans-serif;
    }

    * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }

    body {
      margin: 0; background: var(--bg); color: var(--text);
      font-family: var(--font-ui); height: 100dvh;
      display: flex; flex-direction: column; overflow: hidden;
    }

    /* --- HEADER --- */
    header {
      height: 48px; padding: 0 12px;
      background: var(--surface); border-bottom: 1px solid var(--border);
      display: flex; justify-content: space-between; align-items: center;
      flex-shrink: 0;
    }
    .brand { font-weight: 700; font-size: 14px; display: flex; align-items: center; gap: 8px; }
    .status-dot { width: 8px; height: 8px; background: #238636; border-radius: 50%; }

    .actions button {
      background: transparent; border: 1px solid var(--border); color: var(--text);
      padding: 6px 12px; border-radius: 6px; font-size: 12px; font-weight: 600;
      cursor: pointer; margin-left: 8px;
    }
    .actions .btn-primary { background: var(--accent); border-color: var(--accent); color: #fff; }

    /* --- EDITOR --- */
    .editor-wrapper {
      flex: 1; position: relative; display: flex;
      background: var(--bg); overflow: hidden;
    }
    .gutter {
      width: 40px; padding: 12px 6px 12px 0; text-align: right;
      font-family: var(--font-code); font-size: 13px; line-height: 1.5;
      color: #484f58; border-right: 1px solid var(--border);
    }
    textarea {
      flex: 1; border: none; background: transparent; color: var(--text);
      padding: 12px; font-family: var(--font-code); font-size: 13px;
      line-height: 1.5; resize: none; white-space: pre;
    }

    /* --- ACCESSORY BAR --- */
    .accessory-bar {
      background: var(--surface); border-top: 1px solid var(--border);
      padding: 8px; padding-bottom: max(8px, env(safe-area-inset-bottom));
      display: flex; gap: 8px; overflow-x: auto; align-items: center;
    }
    
    .key {
      flex: 0 0 auto; min-width: 36px; height: 36px;
      background: #21262d; border: 1px solid var(--border);
      border-radius: 6px; color: var(--text);
      display: flex; align-items: center; justify-content: center;
      font-family: var(--font-code); font-size: 15px;
    }
    .key:active { background: var(--accent); border-color: var(--accent); color: #fff; }

    /* --- COLOR TRIGGER BUTTON (Hidden by default) --- */
    #colorBtn {
      display: none; /* Auto-show */
      padding: 0 12px; gap: 8px;
      border: 1px solid var(--accent); color: var(--accent);
      background: rgba(47, 129, 247, 0.1);
      font-size: 12px; font-weight: bold;
      animation: popIn 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
    #swatch {
      width: 14px; height: 14px; border-radius: 3px;
      border: 1px solid rgba(255,255,255,0.4);
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    @keyframes popIn { from {transform: scale(0.8); opacity: 0;} to {transform: scale(1); opacity: 1;} }

  </style>
</head>
<body>

  <header>
    <div class="brand"><div class="status-dot"></div> &nbsp; Onyx Color</div>
    <div class="actions">
      <button onclick="reset()">Reset</button>
      <button class="btn-primary" onclick="launch()">Run ▶</button>
    </div>
  </header>

  <div class="editor-wrapper">
    <div class="gutter" id="gutter">1</div>
    <textarea id="editor" spellcheck="false" autocomplete="off" autocapitalize="none"></textarea>
  </div>

  <div class="accessory-bar" id="bar">
    <button id="colorBtn" class="key" onclick="openPicker()">
      <div id="swatch"></div> <span id="colorLabel">Color</span>
    </button>

    <button class="key" onclick="moveCursor(-1)">←</button>
    <button class="key" onclick="moveCursor(1)">→</button>
    <button class="key" onclick="insert('  ')">TAB</button>
    <button class="key" onclick="insert('#')">#</button>
    <button class="key" onclick="insert(':')">:</button>
    <button class="key" onclick="insert(';')">;</button>
  </div>

  <input type="color" id="nativePicker" style="visibility:hidden; position:absolute; top:-1000px;">

  <script>
    // --- STATE ---
    const defaultData = {
      content: 
`<style>
  body {
    background: #0d1117;
    color: #e6edf3;
    display: flex; justify-content: center;
    align-items: center; height: 100vh;
    font-family: sans-serif;
  }
  .box {
    background: #161b22;
    padding: 2rem;
    border-radius: 1rem;
    border: 1px solid #30363d;
    text-align: center;
  }
  h1 { color: #2f81f7; }
</style>

<div class="box">
  <h1>Onyx Color</h1>
  <p>Real-time Hex Editing</p>
</div>`
    };

    let content = localStorage.getItem('onyx_color') || defaultData.content;

    // --- DOM ---
    const editor = document.getElementById('editor');
    const gutter = document.getElementById('gutter');
    const colorBtn = document.getElementById('colorBtn');
    const swatch = document.getElementById('swatch');
    const picker = document.getElementById('nativePicker');

    // --- INIT ---
    editor.value = content;
    updateGutter();

    // --- EVENTS ---
    editor.addEventListener('input', () => {
      content = editor.value;
      localStorage.setItem('onyx_color', content);
      updateGutter();
    });

    editor.addEventListener('scroll', () => gutter.scrollTop = editor.scrollTop);
    
    // カーソル移動やタップ時に「色コードの上にいるか？」を判定
    editor.addEventListener('click', detectColor);
    editor.addEventListener('keyup', detectColor);

    // ネイティブカラーピッカーの変更を監視 (Real-time)
    picker.addEventListener('input', (e) => {
      applyColor(e.target.value);
    });

    // --- CORE LOGIC ---
    let currentColorRange = null;

    function detectColor() {
      const pos = editor.selectionStart;
      const text = editor.value;
      
      // カーソル周辺のテキストを取得 (前後10文字程度)
      // これにより全テキスト走査を避けて軽量化
      const lookAround = 10;
      const startSearch = Math.max(0, pos - lookAround);
      const endSearch = Math.min(text.length, pos + lookAround);
      const snippet = text.substring(startSearch, endSearch);

      // 正規表現でHexコード(#fff or #000000)を探す
      // カーソル位置(pos)がその範囲内にあるかチェック
      const regex = /#([0-9a-fA-F]{3,6})\b/g;
      let match;
      let found = null;

      // snippet内でのマッチ位置を全体位置に変換して判定
      while ((match = regex.exec(snippet)) !== null) {
        const absStart = startSearch + match.index;
        const absEnd = absStart + match[0].length;
        
        if (pos >= absStart && pos <= absEnd) {
          found = {
            hex: match[0],
            start: absStart,
            end: absEnd
          };
          break;
        }
      }

      if (found) {
        // 色が見つかったらボタンを表示
        currentColorRange = found;
        colorBtn.style.display = 'flex';
        swatch.style.background = found.hex;
        // ピッカーに現在の値をセット (3桁なら6桁に変換)
        picker.value = normalizeHex(found.hex);
      } else {
        colorBtn.style.display = 'none';
        currentColorRange = null;
      }
    }

    function openPicker() {
      picker.click(); // システムピッカーを起動
    }

    function applyColor(newHex) {
      if (!currentColorRange) return;

      const { start, end } = currentColorRange;
      
      // テキストの置換
      const before = editor.value.substring(0, start);
      const after = editor.value.substring(end);
      
      editor.value = before + newHex + after;
      
      // カーソル位置と選択範囲情報の更新
      // これをしないと連続操作で位置がずれる
      const newEnd = start + newHex.length;
      currentColorRange = { hex: newHex, start: start, end: newEnd };
      
      // フォーカス維持
      editor.setSelectionRange(newEnd, newEnd);
      
      // UI更新
      swatch.style.background = newHex;
      content = editor.value; // 保存
    }

    // #fff -> #ffffff 変換ヘルパー
    function normalizeHex(hex) {
      if (hex.length === 4) {
        return '#' + hex[1] + hex[1] + hex[2] + hex[2] + hex[3] + hex[3];
      }
      return hex;
    }

    // --- UTILS ---
    function updateGutter() {
      const lines = editor.value.split('\n').length;
      gutter.innerHTML = Array.from({length: lines}, (_, i) => i + 1).join('<br>');
    }

    function insert(text) {
      const s = editor.selectionStart;
      const e = editor.selectionEnd;
      editor.value = editor.value.substring(0, s) + text + editor.value.substring(e);
      editor.selectionStart = editor.selectionEnd = s + text.length;
      editor.focus();
      editor.dispatchEvent(new Event('input')); // トリガー
    }

    function moveCursor(offset) {
      const pos = editor.selectionStart + offset;
      editor.setSelectionRange(pos, pos);
      editor.focus();
      detectColor(); // 移動後にも判定
    }

    function launch() {
      const blob = new Blob([editor.value], {type: 'text/html'});
      window.open(URL.createObjectURL(blob), '_blank');
    }
    
    function reset() {
      if(confirm('Reset code?')) {
        localStorage.removeItem('onyx_color');
        location.reload();
      }
    }
  </script>
</body>
</html>