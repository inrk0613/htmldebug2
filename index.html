<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover, interactive-widget=resizes-content">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>Aura Code</title>
  <style>
    /* --- DESIGN TOKENS --- */
    :root {
      --bg-root: #050505;
      --bg-surface: #0f1115;
      --bg-panel: #161b22;
      --glass: rgba(22, 27, 34, 0.75);
      --border: rgba(255, 255, 255, 0.08);
      --primary: #3b82f6;
      --primary-glow: rgba(59, 130, 246, 0.3);
      --text-main: #e2e8f0;
      --text-muted: #64748b;
      --font-code: "SF Mono", "Menlo", "Consolas", monospace;
      --safe-top: env(safe-area-inset-top);
      --safe-bottom: env(safe-area-inset-bottom);
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
    
    body {
      margin: 0; background-color: var(--bg-root); color: var(--text-main);
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
      height: 100dvh; display: flex; flex-direction: column; overflow: hidden;
    }

    /* --- LAYOUT --- */
    .app-header {
      padding: calc(var(--safe-top) + 12px) 16px 12px;
      background: var(--glass); backdrop-filter: blur(24px);
      -webkit-backdrop-filter: blur(24px);
      border-bottom: 1px solid var(--border);
      display: flex; justify-content: space-between; align-items: center;
      z-index: 50;
    }

    .logo {
      font-size: 15px; font-weight: 700; letter-spacing: -0.5px;
      display: flex; align-items: center; gap: 8px;
    }
    .logo-icon {
      width: 18px; height: 18px; background: var(--primary);
      border-radius: 6px; box-shadow: 0 0 12px var(--primary-glow);
    }

    .run-btn {
      background: var(--primary); color: white; border: none;
      padding: 6px 16px; border-radius: 20px; font-size: 13px; font-weight: 600;
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.25);
      transition: transform 0.1s;
    }
    .run-btn:active { transform: scale(0.96); }

    /* --- TABS --- */
    .file-tabs {
      display: flex; gap: 8px; padding: 12px 16px; overflow-x: auto;
      background: var(--bg-root); border-bottom: 1px solid var(--border);
    }
    .tab {
      padding: 6px 12px; font-size: 12px; border-radius: 8px;
      color: var(--text-muted); background: transparent;
      border: 1px solid transparent; transition: all 0.2s;
      font-family: var(--font-code);
    }
    .tab.active {
      background: var(--bg-panel); color: var(--text-main);
      border-color: var(--border); box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }

    /* --- EDITOR --- */
    .editor-container {
      flex: 1; position: relative; overflow: hidden; background: var(--bg-surface);
    }
    textarea {
      width: 100%; height: 100%; border: none; resize: none;
      background: transparent; color: #a5b3ce;
      padding: 16px 16px 80px; /* Bottom padding for keyboard accessory */
      font-family: var(--font-code); font-size: 14px; line-height: 1.6;
      white-space: pre; word-wrap: normal; overflow-x: auto;
    }
    textarea::placeholder { color: #334155; }

    /* --- KEYBOARD ACCESSORY --- */
    .accessory-bar {
      position: absolute; bottom: 0; left: 0; right: 0;
      background: var(--glass); backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      border-top: 1px solid var(--border);
      padding: 8px; display: flex; gap: 6px; overflow-x: auto;
      z-index: 20; padding-bottom: max(8px, var(--safe-bottom));
    }
    .key {
      flex: 0 0 auto; min-width: 32px; height: 32px;
      background: rgba(255,255,255,0.06); border-radius: 6px;
      display: flex; align-items: center; justify-content: center;
      font-family: var(--font-code); font-size: 14px; color: var(--text-main);
      border: 1px solid rgba(255,255,255,0.05);
    }
    .key:active { background: rgba(255,255,255,0.15); }

    /* --- PREVIEW MODAL --- */
    .preview-modal {
      position: fixed; inset: 0; background: #fff; z-index: 100;
      transform: translateY(100%); transition: transform 0.35s cubic-bezier(0.32, 0.72, 0, 1);
      display: flex; flex-direction: column;
    }
    .preview-modal.visible { transform: translateY(0); }
    
    .preview-header {
      padding: calc(var(--safe-top) + 10px) 16px 10px;
      background: #f8f9fa; border-bottom: 1px solid #e2e8f0;
      display: flex; justify-content: space-between; align-items: center; color: #000;
    }
    .close-btn {
      background: #e2e8f0; border: none; width: 30px; height: 30px;
      border-radius: 50%; display: flex; align-items: center; justify-content: center;
      color: #475569; font-weight: bold;
    }
    
    iframe { flex: 1; border: none; width: 100%; background: #fff; }

    /* --- TOAST --- */
    #toast {
      position: fixed; top: 20px; left: 50%; transform: translateX(-50%) translateY(-100px);
      background: #10b981; color: white; padding: 10px 20px;
      border-radius: 30px; font-size: 13px; font-weight: 600;
      box-shadow: 0 10px 30px rgba(0,0,0,0.5); z-index: 200;
      transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
    #toast.show { transform: translateX(-50%) translateY(var(--safe-top)); }
  </style>
</head>
<body>

  <header class="app-header">
    <div class="logo">
      <div class="logo-icon"></div>
      Aura Studio
    </div>
    <button class="run-btn" onclick="runApp()">Play</button>
  </header>

  <div class="file-tabs" id="tabContainer">
    </div>

  <div class="editor-container">
    <textarea id="codeEditor" spellcheck="false" autocapitalize="none" autocomplete="off"></textarea>
    
    <div class="accessory-bar" id="accessoryBar">
      </div>
  </div>

  <div class="preview-modal" id="previewModal">
    <div class="preview-header">
      <span style="font-weight:600; font-size:14px;">Running Application</span>
      <button class="close-btn" onclick="closePreview()">✕</button>
    </div>
    <iframe id="previewFrame"></iframe>
  </div>

  <div id="toast">Saved Successfully</div>

  <script>
    // --- STATE MANAGEMENT ---
    const appState = {
      activeFile: 'index.html',
      files: {
        'index.html': 
`<div class="card">
  <h1>Hello World</h1>
  <p>Edit styles and logic in the tabs above.</p>
  <button id="btn">Click Me</button>
</div>`,
        'style.css': 
`body {
  font-family: -apple-system, sans-serif;
  display: flex; justify-content: center; 
  align-items: center; height: 100vh;
  background: #f1f5f9; margin: 0;
}
.card {
  background: white; padding: 2rem;
  border-radius: 20px;
  box-shadow: 0 20px 40px rgba(0,0,0,0.1);
  text-align: center; width: 80%;
}
h1 { color: #0f172a; margin-top: 0; }
button {
  background: #3b82f6; color: white;
  border: none; padding: 12px 24px;
  border-radius: 12px; font-size: 16px;
  margin-top: 1rem;
}`,
        'script.js': 
`const btn = document.getElementById('btn');
btn.addEventListener('click', () => {
  btn.textContent = 'Awesome! ✨';
  btn.style.background = '#10b981';
  alert('Interaction works perfectly!');
});`
      }
    };

    // --- DOM ELEMENTS ---
    const editor = document.getElementById('codeEditor');
    const tabContainer = document.getElementById('tabContainer');
    const accessoryBar = document.getElementById('accessoryBar');
    const previewModal = document.getElementById('previewModal');
    const previewFrame = document.getElementById('previewFrame');

    // --- INITIALIZATION ---
    function init() {
      // Load from LocalStorage if available
      const saved = localStorage.getItem('aura_project');
      if (saved) {
        try {
          appState.files = JSON.parse(saved);
        } catch(e) { console.error('Save corrupted'); }
      }

      renderTabs();
      renderKeys();
      loadFile(appState.activeFile);
    }

    // --- CORE LOGIC ---
    function loadFile(fileName) {
      // Save current content to memory before switching
      appState.files[appState.activeFile] = editor.value;
      
      appState.activeFile = fileName;
      editor.value = appState.files[fileName];
      
      // Update Tab UI
      document.querySelectorAll('.tab').forEach(t => {
        t.classList.toggle('active', t.dataset.file === fileName);
      });
    }

    function renderTabs() {
      tabContainer.innerHTML = '';
      Object.keys(appState.files).forEach(file => {
        const btn = document.createElement('button');
        btn.className = `tab ${file === appState.activeFile ? 'active' : ''}`;
        btn.textContent = file;
        btn.dataset.file = file;
        btn.onclick = () => loadFile(file);
        tabContainer.appendChild(btn);
      });
    }

    function renderKeys() {
      const keys = ['<', '>', '/', '{', '}', '(', ')', ';', '=', '"', "'", '!', '$', '`'];
      keys.forEach(k => {
        const el = document.createElement('div');
        el.className = 'key';
        el.textContent = k;
        el.onclick = (e) => {
          e.preventDefault();
          insertText(k);
        };
        accessoryBar.appendChild(el);
      });
    }

    function insertText(text) {
      const start = editor.selectionStart;
      const end = editor.selectionEnd;
      editor.value = editor.value.substring(0, start) + text + editor.value.substring(end);
      editor.selectionStart = editor.selectionEnd = start + text.length;
      editor.focus();
      triggerSave();
    }

    // --- AUTO SAVE ---
    editor.addEventListener('input', () => {
      appState.files[appState.activeFile] = editor.value;
      triggerSave();
    });

    let saveTimeout;
    function triggerSave() {
      clearTimeout(saveTimeout);
      saveTimeout = setTimeout(() => {
        localStorage.setItem('aura_project', JSON.stringify(appState.files));
      }, 500);
    }

    // --- RUN / PREVIEW ---
    function runApp() {
      // Ensure current buffer is saved to state
      appState.files[appState.activeFile] = editor.value;

      const html = appState.files['index.html'];
      const css = appState.files['style.css'];
      const js = appState.files['script.js'];

      const combinedSource = `
        <!DOCTYPE html>
        <html>
        <head>
          <meta name="viewport" content="width=device-width, initial-scale=1.0">
          <style>${css}</style>
        </head>
        <body>
          ${html}
          <script>
            try {
              ${js}
            } catch(e) {
              document.body.innerHTML += '<div style="color:red; background:#fee; padding:10px; border:1px solid red; margin-top:20px;">' + e + '</div>';
            }
          <\/script>
        </body>
        </html>
      `;

      previewFrame.srcdoc = combinedSource;
      previewModal.classList.add('visible');
    }

    function closePreview() {
      previewModal.classList.remove('visible');
    }

    init();
  </script>
</body>
</html>